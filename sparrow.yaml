tasks:
  -
    name: zef-build
    language: Bash
    default: true
    code: |
      set -e
      cd source/
      zef install . --force-install
      zef install App::Prove6 --force-install
      prove6 -I. t/ it/
    followup:
      -
        name: intergration_tests
  -
    name: intergration_tests
    language: Raku
    init: |
      "{cache_root_dir()}/command.raku".IO.spurt(config()<code>);
      run_task "smoke_test", %(
        command => "{cache_root_dir()}/command.raku"
      );
      CATCH {
           default {
               my $err = .Str;
               set_stdout($err);
           }
      }        
    subtasks:
      -
        name: smoke_test
        language: Bash
        code: |
          set -x
          echo "run: ["
          cat $command
          echo "]"
          nohup raku $command 1>&2 1>log.txt &
          pid=$!
          echo "pid: $pid"
          echo "====="
          echo "GET localhost:8080"
          echo "====="
          sleep 10
          curl http://localhost:8080 -s -D - -L --verbose
          echo "====="
          kill $pid
          echo "log:"
          cat log.txt
    code: |
      say "Finished";
    hub:
      language: Raku
      code: |
        my $code;
        my @examples;
        my $fh = open("source/README.md"); 
        for $fh.lines -> $i { 
          if $i ~~ /^ "```raku"/ ^fff^  $i ~~ /^ "```"/ { 
            $code ~= "$i\n"
          } elsif ($i ~~ /^ "```raku"/ or $fh.eof) { 
            @examples.push(%( config => %( code => $code ) )) if $code; 
            $code = ""; 
          }   
        }
        $fh.close();
        update_state(%( list => @examples ));
